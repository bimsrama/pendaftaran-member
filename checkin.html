<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in Usus Sehat 30 Hari</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0fdf4; }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #16a34a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .gradient-text {
            background: linear-gradient(to right, #16a34a, #15803d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Animasi halus untuk input muncul */
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-gray-800 pb-10">

    <div class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-md mx-auto px-4 py-4 flex items-center justify-between">
            <h1 class="text-xl font-bold text-green-700 flex items-center">
                <i class="fas fa-leaf mr-2"></i>Usus Sehat
            </h1>
            <span id="date-display" class="text-xs text-gray-500 font-medium"></span>
        </div>
    </div>

    <div class="max-w-md mx-auto px-4 mt-6 space-y-6">

        <div id="loading-screen" class="flex flex-col items-center justify-center py-20">
            <div class="loader mb-4"></div>
            <p class="text-gray-500 animate-pulse text-sm">Menghubungkan ke database...</p>
        </div>

        <div id="error-screen" class="hidden text-center py-10 bg-white rounded-xl shadow p-5">
            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-3"></i>
            <h3 class="font-bold text-gray-700">Data Tidak Ditemukan</h3>
            <p class="text-sm text-gray-500 mt-2 mb-4">Pastikan Anda membuka halaman ini melalui link resmi dari WhatsApp.</p>
            <p id="error-detail" class="text-xs text-red-400 font-mono bg-red-50 p-2 rounded">Error detail...</p>
        </div>

        <div id="dashboard-content" class="hidden space-y-6">
            
            <div class="glass-card p-5 border-l-4 border-green-500">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wider">Halo Bestie,</p>
                        <h2 id="user-name" class="text-2xl font-bold gradient-text">Loading...</h2>
                        <span id="user-category" class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mt-1 font-semibold">...</span>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-bold text-green-600" id="current-day">0</div>
                        <div class="text-xs text-gray-500 font-medium">Hari ke-</div>
                    </div>
                </div>

                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2 overflow-hidden">
                    <div id="progress-bar" class="bg-green-600 h-2.5 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-500 font-medium">
                    <span id="progress-text">0% Selesai</span>
                    <span>Target: 30 Hari</span>
                </div>
            </div>

            <div class="glass-card p-5 bg-gradient-to-br from-green-50 to-white relative overflow-hidden border border-green-100">
                <i class="fas fa-robot absolute -top-2 -right-2 text-green-100 text-6xl opacity-60"></i>
                <h3 class="font-bold text-green-800 mb-2 flex items-center relative z-10">
                    <i class="fas fa-lightbulb text-yellow-500 mr-2"></i> Insight Hari Ini
                </h3>
                <p id="ai-insight-text" class="text-sm text-gray-700 italic leading-relaxed relative z-10">
                    "Memuat tips cerdas untuk pencernaanmu..."
                </p>
            </div>

            <div class="glass-card p-6 border-t-4 border-green-600">
                <h3 class="font-bold text-lg mb-4 text-gray-800 flex items-center">
                    <i class="fas fa-calendar-check text-green-600 mr-2"></i> Lapor Check-in
                </h3>
                
                <form id="checkin-form">
                    <input type="hidden" id="wa-input" name="whatsapp">
                    
                    <div class="mb-5">
                        <label id="question-label" class="block text-sm font-semibold text-gray-700 mb-2">
                            Apakah tantangan hari ini sudah dilakukan?
                        </label>
                        
                        <div id="special-input-container" class="hidden animate-fade-in">
                            <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg mb-2 shadow-sm">
                                <p class="text-xs text-yellow-800 mb-2 font-medium">
                                    <i class="fas fa-star mr-1"></i> <strong>Special Question!</strong>
                                </p>
                                <textarea id="detail-jawaban" rows="3" 
                                    class="w-full p-3 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition"
                                    placeholder="Apa yang Anda suka atau alami mengenai usus Anda akhir-akhir ini?"></textarea>
                            </div>
                        </div>

                        <input type="hidden" id="default-jawaban" value="Selesai">
                    </div>

                    <button type="submit" id="btn-submit" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg transform transition active:scale-95 flex justify-center items-center">
                        <span>Check-in Sekarang</span>
                        <i class="fas fa-paper-plane ml-2"></i>
                    </button>
                </form>
            </div>

            <div class="glass-card p-5">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-history text-gray-400 mr-2"></i> Riwayat Perjalanan
                </h3>
                <div class="overflow-y-auto max-h-64 pr-2 custom-scrollbar">
                    <ul id="history-list" class="space-y-4 relative border-l-2 border-gray-200 ml-3 pl-6 pb-2">
                        </ul>
                    <div id="empty-history" class="hidden text-center text-sm text-gray-400 py-6 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                        Belum ada data check-in.
                    </div>
                </div>
            </div>

        </div>
        
        <div class="text-center text-xs text-gray-400 mt-10 mb-6">
            <p>&copy; 2024 Usus Sehat Program</p>
            <p class="mt-1 opacity-70">Sehat dimulai dari pencernaan</p>
        </div>
    </div>

    <script>
        // ============================================
        // ðŸ”— KONFIGURASI LINK APP SCRIPT (SUDAH DIISI)
        // ============================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx67JX5mM-n-W1h6ehURHgONXBPiyUvESRLMCveTV04wXighQQhLErXQwC07Yf5Zkkw/exec"; 
        
        // State Variables
        let userCategory = 'Seimbang';
        let currentDay = 0;

        // Database Tips AI (Diolah di Client-Side agar cepat)
        const aiTips = {
            'A': [ // Si Sembelit
                "Pagi ini, cobalah minum air hangat segera setelah bangun tidur untuk merangsang usus.",
                "Serat dari pepaya atau buah naga sangat lembut untuk membantu pelancaranmu hari ini.",
                "Hindari menahan keinginan ke belakang, respon tubuhmu segera ya!",
                "Gerakan jalan kaki ringan 15 menit bisa membantu peristaltik ususmu."
            ],
            'B': [ // Si Kembung
                "Makanlah perlahan dan kunyah sampai halus agar enzim di mulut bekerja maksimal.",
                "Hindari minuman bersoda atau menggunakan sedotan hari ini untuk mengurangi gas.",
                "Jahe hangat adalah teman terbaikmu saat perut terasa penuh.",
                "Kurangi porsi makan tapi makanlah lebih sering (Small Frequent Feeding)."
            ],
            'C': [ // Si Sensitif
                "Hari ini fokus pada makanan yang dimasak matang (bukan mentah/salad) agar mudah dicerna.",
                "Kelola stresmu, karena usus dan otakmu sangat terhubung (Gut-Brain Axis).",
                "Hindari makanan pedas atau terlalu berlemak untuk mengistirahatkan usus.",
                "Teh chamomile atau peppermint bisa membantu menenangkan saraf usus."
            ],
            'Seimbang': [
                "Pertahankan kebiasaan baikmu! Usus sehat = Imunitas kuat.",
                "Cobalah variasi warna dalam piringmu hari ini untuk memberi makan bakteri baik.",
                "Pastikan hidrasi cukup, air adalah kunci metabolisme lancar.",
                "Dengarkan tubuhmu, berhenti makan sebelum terlalu kenyang."
            ]
        };

        // 1. Inisialisasi Saat Halaman Dibuka
        document.addEventListener('DOMContentLoaded', () => {
            // Set Tanggal Hari Ini di Header (Format Indonesia)
            const options = { weekday: 'long', day: 'numeric', month: 'short', year: 'numeric' };
            document.getElementById('date-display').textContent = new Date().toLocaleDateString('id-ID', options);

            // Ambil Parameter WA dari URL
            const urlParams = new URLSearchParams(window.location.search);
            // Membersihkan karakter non-angka jika ada
            let waParam = urlParams.get('wa');
            if(waParam) waParam = waParam.replace(/[^0-9]/g, "");

            if (waParam) {
                document.getElementById('wa-input').value = waParam;
                fetchUserData(waParam);
            } else {
                showError("Link tidak valid. Tidak ada nomor WhatsApp terdeteksi.");
            }
        });

        // 2. Fungsi Ambil Data User (GET Request)
        function fetchUserData(wa) {
            console.log("Fetching data for:", wa);
            fetch(`${SCRIPT_URL}?action=getData&wa=${wa}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Data received:", data);
                    if (data.status === 'success') {
                        renderDashboard(data);
                    } else {
                        showError(data.message || "Nomor WhatsApp tidak ditemukan di database.");
                    }
                })
                .catch(error => {
                    console.error('Fetch Error:', error);
                    showError("Gagal terhubung ke server. Coba refresh halaman.");
                });
        }

        // 3. Render Tampilan Dashboard
        function renderDashboard(data) {
            // Hide Loader, Show Content
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('dashboard-content').classList.remove('hidden');

            // Mapping Kategori dari App Script ke Kode (A/B/C)
            const catName = data.kategori; // Misal: "Si Sembelit"
            if (catName.includes('Sembelit')) userCategory = 'A';
            else if (catName.includes('Kembung')) userCategory = 'B';
            else if (catName.includes('Sensitif')) userCategory = 'C';
            else userCategory = 'Seimbang';

            currentDay = parseInt(data.hari);

            // Populate Profile UI
            document.getElementById('user-name').textContent = data.nama;
            document.getElementById('user-category').textContent = catName;
            document.getElementById('current-day').textContent = currentDay;
            
            // Progress Bar Animation
            const progress = data.progress;
            setTimeout(() => {
                document.getElementById('progress-bar').style.width = `${progress}%`;
            }, 500);
            document.getElementById('progress-text').textContent = `${progress}% Perjalanan`;

            // Generate AI Insight
            const tipsList = aiTips[userCategory] || aiTips['Seimbang'];
            const randomTip = tipsList[Math.floor(Math.random() * tipsList.length)];
            document.getElementById('ai-insight-text').innerHTML = `"${randomTip}"`;

            // Setup Form (Logic Kelipatan 6 Hari)
            setupCheckinForm(currentDay);

            // Render History Log
            renderHistory(data.checkin_log);
        }

        // 4. Logika Form Check-in Khusus
        function setupCheckinForm(day) {
            const specialContainer = document.getElementById('special-input-container');
            const label = document.getElementById('question-label');
            const detailInput = document.getElementById('detail-jawaban');

            // Jika Hari > 0 DAN Kelipatan 6 (6, 12, 18, 24, 30)
            if (day > 0 && day % 6 === 0) {
                specialContainer.classList.remove('hidden');
                detailInput.required = true;
                label.innerHTML = `ðŸŒŸ <strong>Evaluasi Hari ke-${day}:</strong>`;
                label.classList.add('text-green-700');
            } else {
                specialContainer.classList.add('hidden');
                detailInput.required = false;
                detailInput.value = ""; 
                label.textContent = "Apakah tantangan hari ini sudah dilakukan?";
                label.classList.remove('text-green-700');
            }
        }

        // 5. Render History List
        function renderHistory(logs) {
            const listContainer = document.getElementById('history-list');
            listContainer.innerHTML = '';

            if (!logs || logs.length === 0) {
                document.getElementById('empty-history').classList.remove('hidden');
                return;
            }

            logs.forEach(log => {
                // Log format: { tanggal, jam, waktu, ket, detail, hari }
                const isSpecialAnswer = log.detail && log.detail !== "Selesai" && log.detail !== "-";
                
                const li = document.createElement('li');
                li.className = "mb-4 relative animate-fade-in";
                
                let contentHTML = `
                    <div class="absolute -left-[31px] mt-1.5 w-4 h-4 rounded-full bg-green-500 border-2 border-white shadow ring-2 ring-green-100"></div>
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="block text-sm font-bold text-gray-800">${log.ket}</span>
                            <span class="text-xs text-gray-500"><i class="far fa-clock mr-1"></i>${log.waktu}</span>
                        </div>
                    </div>
                `;

                if (isSpecialAnswer) {
                    contentHTML += `
                        <div class="mt-2 bg-gray-50 p-3 rounded-lg text-xs text-gray-600 italic border-l-4 border-green-300 shadow-sm">
                            "${log.detail}"
                        </div>
                    `;
                }

                li.innerHTML = contentHTML;
                listContainer.appendChild(li);
            });
        }

        // 6. Handle Submit Check-in
        document.getElementById('checkin-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const btn = document.getElementById('btn-submit');
            const originalBtnText = btn.innerHTML;
            
            // UI Loading State
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Mengirim...';

            const wa = document.getElementById('wa-input').value;
            let detail = "Selesai";
            const specialInput = document.getElementById('detail-jawaban');
            
            // Jika input khusus sedang aktif, ambil nilainya
            if (!document.getElementById('special-input-container').classList.contains('hidden')) {
                detail = specialInput.value;
            }

            // Kirim Data via POST (FormData)
            const formData = new FormData();
            formData.append('action', 'checkin');
            formData.append('whatsapp', wa);
            formData.append('detail', detail);

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    Swal.fire({
                        title: 'Berhasil!',
                        text: 'Laporan check-in harianmu sudah tersimpan.',
                        icon: 'success',
                        confirmButtonColor: '#16a34a',
                        confirmButtonText: 'Mantap!'
                    }).then(() => {
                        window.location.reload(); // Reload untuk refresh data terbaru
                    });
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                Swal.fire({
                    title: 'Gagal Check-in',
                    text: error.message || 'Terjadi kesalahan koneksi.',
                    icon: 'error',
                    confirmButtonColor: '#d33'
                });
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                btn.innerHTML = originalBtnText;
            });
        });

        // Helper: Tampilkan Error Screen
        function showError(msg) {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('error-screen').classList.remove('hidden');
            document.getElementById('error-detail').textContent = msg;
        }

    </script>
</body>
</html>
