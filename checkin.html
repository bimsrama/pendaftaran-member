<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in Harian | My Gut Journey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0a0a0a; color: white; }
        
        /* Glassmorphism Effect */
        .glass { 
            background: rgba(30, 30, 30, 0.6); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        /* Gradient Text */
        .text-gold { 
            background: linear-gradient(135deg, #FDE68A 0%, #D97706 100%); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1a1a1a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

        /* Animation */
        .fade-in { animation: fadeIn 0.6s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader */
        .loader-spin {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #d97706;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen pb-10">

    <div class="fixed top-0 left-0 w-full z-40 bg-[#0a0a0a]/90 backdrop-blur-md border-b border-white/5">
        <div class="max-w-md mx-auto px-5 py-4 flex items-center justify-between">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <span class="text-amber-500"><i class="fas fa-leaf"></i></span>
                <span class="tracking-wide text-white">DAILY CHECK-IN</span>
            </h1>
            <span id="date-display" class="text-[10px] text-neutral-400 font-mono border border-white/10 px-2 py-1 rounded">...</span>
        </div>
    </div>

    <div class="max-w-md mx-auto px-4 mt-20 space-y-5">

        <div id="loading-screen" class="flex flex-col items-center justify-center py-20">
            <div class="loader-spin mb-4"></div>
            <p class="text-[10px] text-neutral-500 tracking-widest animate-pulse">CONNECTING TO DATABASE...</p>
        </div>

        <div id="error-screen" class="hidden text-center py-10 bg-red-900/10 rounded-2xl border border-red-500/20 p-5 mx-4">
            <i class="fas fa-wifi text-3xl text-red-500 mb-3"></i>
            <h3 class="font-bold text-red-400 text-sm">Gagal Memuat Data</h3>
            <p class="text-xs text-neutral-400 mt-2">Pastikan link WhatsApp benar.</p>
        </div>

        <div id="dashboard-content" class="hidden space-y-5">
            
            <div class="glass rounded-3xl p-6 relative overflow-hidden fade-in" style="animation-delay: 0.1s;">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-amber-600/20 rounded-full blur-[50px]"></div>

                <div class="flex items-center justify-between mb-4 relative z-10">
                    <div>
                        <p class="text-[10px] text-neutral-400 uppercase tracking-widest mb-1">Welcome Back,</p>
                        <h2 id="user-name" class="text-xl font-bold text-white truncate max-w-[180px]">...</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span id="user-category" class="text-[10px] bg-amber-500/10 text-amber-500 px-2 py-0.5 rounded border border-amber-500/20 font-bold">...</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-4xl font-bold text-gold" id="current-day">0</div>
                        <div class="text-[10px] text-neutral-500 uppercase font-bold">Hari Ke</div>
                    </div>
                </div>

                <div class="w-full bg-neutral-800 rounded-full h-2 mb-2 overflow-hidden border border-white/5">
                    <div id="progress-bar" class="bg-gradient-to-r from-amber-500 to-orange-600 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-[10px] text-neutral-500 font-mono">
                    <span id="progress-text">0%</span>
                    <span>GOAL: 30 DAYS</span>
                </div>
            </div>

            <div class="fade-in" style="animation-delay: 0.2s;">
                <a id="btn-to-report" href="#" class="group relative w-full flex items-center justify-between p-4 bg-gradient-to-r from-neutral-800 to-neutral-900 rounded-2xl border border-white/10 hover:border-amber-500/50 transition-all duration-300">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-amber-500/10 flex items-center justify-center text-amber-500 group-hover:scale-110 transition">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <div class="text-left">
                            <p class="text-sm font-bold text-white">Buka Laporan Final</p>
                            <p class="text-[10px] text-neutral-400">Lihat grafik & statistik lengkap</p>
                        </div>
                    </div>
                    <div class="text-neutral-500 group-hover:text-amber-500 transition group-hover:translate-x-1">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </a>
            </div>

            <div class="glass rounded-3xl p-5 border border-blue-500/20 relative overflow-hidden fade-in" style="animation-delay: 0.3s;">
                <i class="fas fa-robot absolute -bottom-3 -right-3 text-blue-500/10 text-6xl pointer-events-none"></i>
                
                <div class="flex justify-between items-center mb-2 relative z-10">
                    <h3 class="font-bold text-xs text-blue-400 flex items-center gap-2">
                        <i class="fas fa-lightbulb"></i> AI DAILY TIP
                    </h3>
                    <button onclick="refreshTip()" class="group flex items-center gap-1 text-[10px] bg-blue-500/10 hover:bg-blue-500/20 text-blue-300 px-2 py-1 rounded-full transition-all active:scale-95 border border-blue-500/20">
                        <i id="refresh-icon" class="fas fa-sync-alt group-hover:text-white"></i>
                        <span class="font-semibold group-hover:text-white">Refresh</span>
                    </button>
                </div>

                <p id="ai-insight-text" class="text-xs text-neutral-300 italic leading-relaxed relative z-10 transition-opacity duration-300">
                    "Memuat tips cerdas..."
                </p>
            </div>

            <div class="glass rounded-3xl p-6 border-t-2 border-amber-500 fade-in" style="animation-delay: 0.4s;">
                <h3 class="font-bold text-sm text-white mb-4 flex items-center gap-2">
                    <i class="fas fa-calendar-check text-amber-500"></i> FORM CHECK-IN
                </h3>
                
                <form id="checkin-form">
                    <input type="hidden" id="wa-input" name="whatsapp">
                    
                    <div class="mb-5">
                        <label id="question-label" class="block text-xs font-semibold text-neutral-400 mb-2 uppercase tracking-wider">
                            Status Tantangan Hari Ini
                        </label>
                        
                        <div id="special-input-container" class="hidden mb-3">
                            <div class="p-3 bg-amber-500/10 border border-amber-500/30 rounded-xl">
                                <p class="text-[10px] text-amber-400 mb-2 font-bold flex items-center gap-1">
                                    <i class="fas fa-star"></i> SPECIAL DAY QUESTION
                                </p>
                                <textarea id="detail-jawaban" rows="3" 
                                    class="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-sm text-white placeholder-neutral-600 focus:outline-none focus:border-amber-500 transition"
                                    placeholder="Ceritakan perubahan apa yang Anda rasakan pada pencernaan Anda?"></textarea>
                            </div>
                        </div>

                        <input type="hidden" id="default-jawaban" value="Selesai">
                        
                        <div class="flex items-center gap-2 text-xs text-neutral-500 mb-2">
                            <i class="fas fa-info-circle"></i> Pastikan sudah melakukan tantangan di WA.
                        </div>
                    </div>

                    <button type="submit" id="btn-submit" 
                        class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg shadow-green-900/20 transform transition active:scale-95 flex justify-center items-center gap-2">
                        <span>LAPOR SELESAI</span>
                        <i class="fas fa-check-circle"></i>
                    </button>
                </form>
            </div>

            <div class="glass rounded-3xl p-5 fade-in" style="animation-delay: 0.5s;">
                <h3 class="font-bold text-xs text-neutral-400 mb-4 flex items-center gap-2 border-b border-white/5 pb-2">
                    <i class="fas fa-history"></i> RIWAYAT PERJALANAN
                </h3>
                <div class="overflow-y-auto max-h-56 pr-2 custom-scrollbar">
                    <ul id="history-list" class="space-y-3">
                        </ul>
                    <div id="empty-history" class="hidden text-center py-6">
                        <p class="text-[10px] text-neutral-600 italic">Belum ada data check-in.</p>
                    </div>
                </div>
            </div>

        </div>
        
        <div class="text-center pb-6 pt-4">
            <p class="text-[10px] text-neutral-600">My Gut Journey &copy; 2024</p>
        </div>
    </div>

    <script>
        // ============================================
        // ðŸ”— KONFIGURASI
        // ============================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx67JX5mM-n-W1h6ehURHgONXBPiyUvESRLMCveTV04wXighQQhLErXQwC07Yf5Zkkw/exec"; 
        const REPORT_PAGE_URL = "laporan.html"; 

        // State Variables
        let userCategory = 'Seimbang';
        let currentDay = 0;
        let waNumber = "";

        // Tips AI Database
        const aiTips = {
            'A': [ 
                "Minum air hangat pagi ini untuk 'membangunkan' usus.", 
                "Serat pepaya sangat lembut untukmu hari ini.", 
                "Lakukan pernapasan perut 5 menit untuk relaksasi.",
                "Hindari menahan BAB, segera ke toilet jika terasa.",
                "Tambahkan satu sendok minyak zaitun ke saladmu."
            ],
            'B': [ 
                "Hindari sedotan agar tidak menelan udara berlebih.", 
                "Kunyah makanan hingga benar-benar halus (30x kunyah).", 
                "Jahe hangat sangat ampuh meredakan gas perut.",
                "Hindari makan sambil berbicara terlalu banyak.",
                "Kurangi konsumsi kol, brokoli, dan minuman bersoda hari ini."
            ],
            'C': [ 
                "Makan makanan hangat dan matang (hindari raw food).", 
                "Kelola stres, ususmu sangat peka terhadap pikiran.", 
                "Makan porsi kecil tapi sering (5x sehari).",
                "Teh chamomile dapat menenangkan saraf ususmu.",
                "Hindari makanan yang terlalu pedas atau asam hari ini."
            ],
            'Seimbang': [ 
                "Pertahankan konsistensi pola makan sehatmu!", 
                "Variasikan warna di piringmu untuk nutrisi lengkap.", 
                "Jangan lupa hidrasi yang cukup, minimal 2 liter.",
                "Dengarkan tubuhmu, berhenti makan sebelum kenyang.",
                "Tidur yang cukup membantu regenerasi sel usus."
            ]
        };

        // 1. Init
        document.addEventListener('DOMContentLoaded', () => {
            const options = { weekday: 'long', day: 'numeric', month: 'short' };
            document.getElementById('date-display').textContent = new Date().toLocaleDateString('id-ID', options);

            const urlParams = new URLSearchParams(window.location.search);
            let waParam = urlParams.get('wa');
            
            if(waParam) {
                waParam = waParam.replace(/[^0-9]/g, "");
                waNumber = waParam;
                document.getElementById('wa-input').value = waNumber;
                document.getElementById('btn-to-report').href = `${REPORT_PAGE_URL}?wa=${waNumber}`;
                fetchUserData(waNumber);
            } else {
                showError("Link tidak valid. Buka dari WhatsApp.");
            }
        });

        // 2. Refresh Tip Function (NEW Feature)
        function refreshTip() {
            // Animasi Icon
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('fa-spin');
            
            // Text Element
            const textEl = document.getElementById('ai-insight-text');
            
            // Efek Fade Out
            textEl.style.opacity = '0';

            setTimeout(() => {
                icon.classList.remove('fa-spin');
                
                // Ambil Tips Baru
                const tipsList = aiTips[userCategory] || aiTips['Seimbang'];
                let newTip = tipsList[Math.floor(Math.random() * tipsList.length)];
                
                // Pastikan tidak mengambil tips yang sama persis (jika list > 1)
                const currentText = textEl.innerText.replace(/"/g, '');
                if(tipsList.length > 1) {
                    while (newTip === currentText) {
                        newTip = tipsList[Math.floor(Math.random() * tipsList.length)];
                    }
                }

                // Update Text & Fade In
                textEl.innerHTML = `"${newTip}"`;
                textEl.style.opacity = '1';
                
            }, 500); // Waktu animasi (0.5 detik)
        }

        // 3. Fetch Data
        function fetchUserData(wa) {
            fetch(`${SCRIPT_URL}?action=getData&wa=${wa}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        renderDashboard(data);
                    } else {
                        showError("Data user tidak ditemukan.");
                    }
                })
                .catch(error => {
                    console.error(error);
                    showError("Gagal koneksi ke server.");
                });
        }

        // 4. Render Dashboard
        function renderDashboard(data) {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('dashboard-content').classList.remove('hidden');

            const catName = data.kategori;
            if (catName.includes('Sembelit')) userCategory = 'A';
            else if (catName.includes('Kembung')) userCategory = 'B';
            else if (catName.includes('Sensitif')) userCategory = 'C';
            else userCategory = 'Seimbang';

            currentDay = parseInt(data.hari);

            // Profile
            document.getElementById('user-name').textContent = data.nama;
            document.getElementById('user-category').textContent = catName.toUpperCase();
            document.getElementById('current-day').textContent = currentDay;
            
            // Progress
            setTimeout(() => {
                document.getElementById('progress-bar').style.width = `${data.progress}%`;
            }, 500);
            document.getElementById('progress-text').textContent = `${data.progress}%`;

            // Load Initial Tip
            refreshTip(); 

            // Logic Form
            setupCheckinForm(currentDay);

            // Logic History
            renderHistory(data.checkin_log);
        }

        // 5. Form Logic
        function setupCheckinForm(day) {
            const specialContainer = document.getElementById('special-input-container');
            const detailInput = document.getElementById('detail-jawaban');
            const label = document.getElementById('question-label');

            if (day > 0 && day % 6 === 0) {
                specialContainer.classList.remove('hidden');
                detailInput.required = true;
                label.innerHTML = `<span class="text-amber-500">â˜…</span> EVALUASI HARI KE-${day}`;
            } else {
                specialContainer.classList.add('hidden');
                detailInput.required = false;
                detailInput.value = ""; 
                label.innerHTML = "STATUS TANTANGAN HARI INI";
            }
        }

        // 6. Render History
        function renderHistory(logs) {
            const listContainer = document.getElementById('history-list');
            listContainer.innerHTML = '';

            if (!logs || logs.length === 0) {
                document.getElementById('empty-history').classList.remove('hidden');
                return;
            }

            logs.forEach(log => {
                const isSpecial = log.detail && log.detail !== "Selesai" && log.detail !== "-";
                
                const li = document.createElement('li');
                li.className = "bg-white/5 p-3 rounded-xl border border-white/5 hover:bg-white/10 transition group";
                
                let html = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]"></div>
                            <div>
                                <p class="text-xs font-bold text-white group-hover:text-amber-500 transition">${log.ket}</p>
                                <p class="text-[10px] text-neutral-500">${log.waktu}</p>
                            </div>
                        </div>
                        <i class="fas fa-check text-green-500/50 text-xs"></i>
                    </div>
                `;

                if (isSpecial) {
                    html += `
                        <div class="mt-2 text-[10px] text-neutral-400 italic bg-black/20 p-2 rounded border-l-2 border-amber-500">
                            "${log.detail}"
                        </div>
                    `;
                }

                li.innerHTML = html;
                listContainer.appendChild(li);
            });
        }

        // 7. Handle Submit
        document.getElementById('checkin-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const btn = document.getElementById('btn-submit');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> SENDING...';
            btn.classList.add('opacity-70', 'cursor-not-allowed');

            let detail = "Selesai";
            if (!document.getElementById('special-input-container').classList.contains('hidden')) {
                detail = document.getElementById('detail-jawaban').value;
            }

            const formData = new FormData();
            formData.append('action', 'checkin');
            formData.append('whatsapp', waNumber);
            formData.append('detail', detail);

            fetch(SCRIPT_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.result === 'success') {
                    Swal.fire({
                        background: '#1a1a1a',
                        color: '#fff',
                        icon: 'success',
                        title: 'Check-in Berhasil!',
                        text: 'Progresmu telah disimpan.',
                        confirmButtonColor: '#d97706'
                    }).then(() => window.location.reload());
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(err => {
                Swal.fire({
                    background: '#1a1a1a',
                    color: '#fff',
                    icon: 'error',
                    title: 'Gagal',
                    text: err.message || 'Error koneksi.',
                    confirmButtonColor: '#ef4444'
                });
                btn.disabled = false;
                btn.classList.remove('opacity-70', 'cursor-not-allowed');
                btn.innerHTML = originalText;
            });
        });

        function showError(msg) {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('error-screen').classList.remove('hidden');
            document.querySelector('#error-screen p').textContent = msg;
        }
    </script>
</body>
</html>
